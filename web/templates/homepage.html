{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1>Wavfrm</h1>
    <h3>Upload audio and get a visual waveform image and embeddable player.</h3>

    <div id="status" style="display: none;">
        <h2></h2>
        <div class="progress"><div class="bar"></div></div>
    </div>

    <div class="row-fluid">

        <div class="span4">
            <form id="track_form" class="form-inline">
                <div class="control-group">
                    <label class="">URL:</label>
                    <div class="controls">
                        <input required="required" name="url" class="input-small" type="text" style="width: 100%" />
                    </div>
                </div>
                <div class="control-group">

                    <label>Bass Color:</label>
                    <div class="controls">
                        <input class="colorpicker input-small" name="color" value="161616" />
                    </div>
                </div>
                <div class="control-group">
                    <label>Treble Color:</label>
                    <div class="controls">
                        <input class="colorpicker input-small" name="color_centroid" value="006699" />
                    </div>
                </div>

            </form>

            <form id="hashform">
                <label>Section Marker Color</label><input class="colorpicker" name="section_color" value="52d3d3" />
                <label>Button Color</label><input class="colorpicker" name="button_color" value="52d3d3" />
            </form>

            <div class="control-group">
                <a class="btn btn-large btn-primary" id="submit">Go</a>
            </div>
        </div>

        <div id="result" class="span8" style="display: none">
            <div id="img_container"></div>

            <iframe id="player" scrolling="no" border="0" width="100%" height="240"></iframe>

            <label>Embed Player</label>
            <textarea id="embed_code"></textarea>

            <label>Image Tag</label>
            <textarea id="img_tag"></textarea>
        </div>

    </div>
</div>
<script>

$(function() {
    var waveform_id, track_id, pollCount = 0;
    var statusPercentages = {
        waiting: 10,
        downloading: 30,
        processing: 50,
        drawing: 70,
        echonest: 90,
        complete: 100
    }

    var showResult = function() {
        var imgHtml = '<img src="http://' + document.location.host + '/waveform/' + waveform_id + '/" />'
        //$('#img_container').html(imgHtml)
        $('#img_tag').val(imgHtml)
        var hashParams = preparePost($('#hashform'))
        var hashQuery = '#' + $.param(hashParams)
        $('#player').attr('src', '/player/' + waveform_id + hashQuery)

        $('#embed_code').val('<iframe width="100%" height="240px" src="http://' + document.location.host + '/player/' + waveform_id + hashQuery + '" scrolling="no" border="0"></iframe>')
        $('#result').show()
    }

    var pollStatus = function() {
        $.getJSON('/waveform/' + waveform_id + '/', function(data) {
            $('#status h2').html(data.status)
            if (data.status == 'complete' || data.status == 'error') {
                $('#status h2').html('Complete!')
                $('#status').slideUp().delay(3000)
                showResult()
                return
            }
            $('#status .progress .bar').width(statusPercentages[data.status] + '%')
            pollCount++
            if (pollCount <= 100) setTimeout(pollStatus, 2000)
        })
    }

    var preparePost = function(form) {
        var params = form.serializeArray(true)
        var post = {}
        params = _.filter(params, function(param) { return param.value != '' })
        $(params).each(function(i, param) {
            if (param.value[0] == '#') params[i].value = param.value.replace('#', '')
            post[param.name] = param.value
        })
        return post
    }

    $('#submit').click(function() {
        var form = $('#track_form')
        var post = preparePost(form)
        $.getJSON('/waveform/', post, function(data) {
            waveform_id = data.waveform_id
            track_id = data.track_id
            if (data.status == 'complete') {
                showResult()
                return
            }
            $('#status').show()
            pollStatus()
        })
        return false
    })

    $('input.colorpicker').spectrum({
        showInput: true
    });
})


</script>
<style>

#img_container {
    height: 200px;
    display: none
}
#img_container img {
    width: 100%;
    height: 100%;
}
#player {
    border: 2px dashed grey;
}
#result textarea {
    width: 100%
}
#container { width: 100% }
.container { width: 90%; margin: auto }

</style>
{% endblock %}